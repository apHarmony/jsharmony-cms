{
  "{schema}.branch_items":{ "object": [ ] },
  // fill in all the merge columns so we don't have to duplicate every other statement to deal with conflict/non-conflict
  "{schema}.merge_copy_src_edit_to_dst_merge":{
    "params": ["OBJECT", "src_branch_id", "dst_branch_id"],
    "sql": [
      "update {schema}.branch_%%%OBJECT%%% ",
      "set ",
        "%%%OBJECT%%%_merge_id=",
          "(select %%%OBJECT%%%_id ",
            "from ",
              "(select %%%OBJECT%%%_id,%%%OBJECT%%%_key src_%%%OBJECT%%%_key ",
                "from {schema}.branch_%%%OBJECT%%% ",
                "where branch_id=%%%src_branch_id%%% ",
              ") tbl ",
            "where src_%%%OBJECT%%%_key=%%%OBJECT%%%_key ",
          "),",
        "branch_%%%OBJECT%%%_merge_action=",
          "(select branch_%%%OBJECT%%%_action ",
            "from ",
              "(select branch_%%%OBJECT%%%_action,%%%OBJECT%%%_key src_%%%OBJECT%%%_key ",
                "from {schema}.branch_%%%OBJECT%%% ",
                "where branch_id=%%%src_branch_id%%% ",
              ") tbl ",
            "where src_%%%OBJECT%%%_key=%%%OBJECT%%%_key ",
          ") ",
      "where branch_id=%%%dst_branch_id%%% ",
        "and %%%OBJECT%%%_merge_id is null ",
        "and branch_%%%OBJECT%%%_merge_action is null ",
        "and %%%OBJECT%%%_key in ",
          "(select %%%OBJECT%%%_key ",
            "from {schema}.branch_%%%OBJECT%%% ",
            "where branch_id=%%%src_branch_id%%% ",
              "and (branch_%%%OBJECT%%%_action is not null)",
          ");"
    ]
  },
  "{schema}.merge_clear_edit_on_public":{
    "params": ["OBJECT", "dst_branch_id"],
    "sql": [
      "delete from {schema}.branch_%%%OBJECT%%% where branch_id=%%%dst_branch_id%%% and branch_%%%OBJECT%%%_action='DELETE' and 'PUBLIC'=(select branch_type from {schema}.branch where branch_id=%%%dst_branch_id%%%);",
      "update {schema}.branch_%%%OBJECT%%% set branch_%%%OBJECT%%%_action=null,%%%OBJECT%%%_orig_id=%%%OBJECT%%%_id where branch_id=%%%dst_branch_id%%% and (branch_%%%OBJECT%%%_action='ADD' or branch_%%%OBJECT%%%_action='UPDATE') and 'PUBLIC'=(select branch_type from {schema}.branch where branch_id=%%%dst_branch_id%%%);"
    ]
  },
  "{schema}.merge_overwrite":{
    "params": ["OBJECT", "src_branch_id", "dst_branch_id"],
    "sql": [
      // not in source branch
      "delete from {schema}.branch_%%%OBJECT%%% where branch_id=%%%dst_branch_id%%% and %%%OBJECT%%%_key not in (select %%%OBJECT%%%_key from {schema}.branch_%%%OBJECT%%% where branch_id=%%%src_branch_id%%%);",

      // in source but marked as delete (no page id)
      "delete from {schema}.branch_%%%OBJECT%%% where branch_id=%%%dst_branch_id%%% and %%%OBJECT%%%_key in (select %%%OBJECT%%%_key from {schema}.branch_%%%OBJECT%%% where branch_id=%%%src_branch_id%%% and branch_%%%OBJECT%%%_action='DELETE');",

      "update {schema}.branch_%%%OBJECT%%% set ",
        "%%%OBJECT%%%_id=(select %%%OBJECT%%%_id ",
          "from (select %%%OBJECT%%%_id,%%%OBJECT%%%_key src_%%%OBJECT%%%_key from {schema}.branch_%%%OBJECT%%% where branch_id=%%%src_branch_id%%%) ",
          "where src_%%%OBJECT%%%_key=%%%OBJECT%%%_key), ",
        "%%%OBJECT%%%_orig_id=(select %%%OBJECT%%%_orig_id ",
          "from (select %%%OBJECT%%%_orig_id,%%%OBJECT%%%_key src_%%%OBJECT%%%_key from {schema}.branch_%%%OBJECT%%% where branch_id=%%%src_branch_id%%%) ",
          "where src_%%%OBJECT%%%_key=%%%OBJECT%%%_key), ",
        "branch_%%%OBJECT%%%_action=(select branch_%%%OBJECT%%%_action ",
          "from (select branch_%%%OBJECT%%%_action,%%%OBJECT%%%_key src_%%%OBJECT%%%_key from {schema}.branch_%%%OBJECT%%% where branch_id=%%%src_branch_id%%%) ",
          "where src_%%%OBJECT%%%_key=%%%OBJECT%%%_key) ",
      "where branch_id=%%%dst_branch_id%%% ",
        "and %%%OBJECT%%%_key in (select %%%OBJECT%%%_key from {schema}.branch_%%%OBJECT%%% where branch_id=%%%src_branch_id%%%);",

      "insert into {schema}.branch_%%%OBJECT%%%(branch_id, %%%OBJECT%%%_key, %%%OBJECT%%%_id, %%%OBJECT%%%_orig_id, branch_%%%OBJECT%%%_action) select %%%dst_branch_id%%%, %%%OBJECT%%%_key, %%%OBJECT%%%_id, %%%OBJECT%%%_orig_id, branch_%%%OBJECT%%%_action from {schema}.branch_%%%OBJECT%%% where branch_id=%%%src_branch_id%%% and %%%OBJECT%%%_key not in (select %%%OBJECT%%%_key from {schema}.branch_%%%OBJECT%%% where branch_id=%%%dst_branch_id%%%);"
    ]
  },
  "{schema}.merge_apply":{
    "params": ["OBJECT", "src_branch_id", "dst_branch_id"],
    "sql": [
      "{schema}.merge_copy_src_edit_to_dst_merge(%%%OBJECT%%%, %%%src_branch_id%%%, %%%dst_branch_id%%%);",

      "delete from {schema}.branch_%%%OBJECT%%% where branch_id=%%%dst_branch_id%%% and branch_%%%OBJECT%%%_merge_action='DELETE';",

      "update {schema}.branch_%%%OBJECT%%% set %%%OBJECT%%%_id=%%%OBJECT%%%_merge_id,branch_%%%OBJECT%%%_action='UPDATE' where branch_id=%%%dst_branch_id%%% and (branch_%%%OBJECT%%%_merge_action='ADD' or branch_%%%OBJECT%%%_merge_action='UPDATE') and branch_%%%OBJECT%%%_action='DELETE';",

      "update {schema}.branch_%%%OBJECT%%% set %%%OBJECT%%%_id=%%%OBJECT%%%_merge_id where branch_id=%%%dst_branch_id%%% and (branch_%%%OBJECT%%%_merge_action='ADD' or branch_%%%OBJECT%%%_merge_action='UPDATE');",

      "insert into {schema}.branch_%%%OBJECT%%%(branch_id, %%%OBJECT%%%_key, %%%OBJECT%%%_id, %%%OBJECT%%%_orig_id) select %%%dst_branch_id%%%, %%%OBJECT%%%_key, %%%OBJECT%%%_id, %%%OBJECT%%%_id from {schema}.branch_%%%OBJECT%%% where branch_id=%%%src_branch_id%%% and (branch_%%%OBJECT%%%_action='ADD' or branch_%%%OBJECT%%%_action='UPDATE') and %%%OBJECT%%%_key not in (select %%%OBJECT%%%_key from {schema}.branch_%%%OBJECT%%% where branch_id=%%%dst_branch_id%%%);",
    ]
  },
  "{schema}.merge_changes":{
    "params": ["OBJECT", "src_branch_id", "dst_branch_id"],
    "sql": [
      "{schema}.merge_copy_src_edit_to_dst_merge(%%%OBJECT%%%,  %%%src_branch_id%%%,  %%%dst_branch_id%%%);",

      // ADD on UPDATE/DELETE/unchanged: UPDATE with dst orig
      "update {schema}.branch_%%%OBJECT%%% set ",
        "%%%OBJECT%%%_id=%%%OBJECT%%%_merge_id, ",
        "branch_%%%OBJECT%%%_action='UPDATE', ",
        "%%%OBJECT%%%_merge_id=null, ",
        "branch_%%%OBJECT%%%_merge_action=null ",
      "where branch_id= %%%dst_branch_id%%% ",
        "and (branch_%%%OBJECT%%%_action='DELETE' or branch_%%%OBJECT%%%_action='UPDATE' or branch_%%%OBJECT%%%_action is null) ",
        "and branch_%%%OBJECT%%%_merge_action='ADD';",

      // UPDATE/DELETE on ADD: use src orig
      "update {schema}.branch_%%%OBJECT%%% set ",
        "%%%OBJECT%%%_id=%%%OBJECT%%%_merge_id, ",
        "branch_%%%OBJECT%%%_action=branch_%%%OBJECT%%%_merge_action, ",
        "%%%OBJECT%%%_orig_id=( ",
          "select %%%OBJECT%%%_orig_id ",
          "from ( ",
            "select ",
              "%%%OBJECT%%%_orig_id, ",
              "%%%OBJECT%%%_key src_%%%OBJECT%%%_key ",
            "from {schema}.branch_%%%OBJECT%%% ",
            "where branch_id= %%%src_branch_id%%% ",
          ") tbl ",
          "where src_%%%OBJECT%%%_key=%%%OBJECT%%%_key ",
        "), ",
        "%%%OBJECT%%%_merge_id=null, ",
        "branch_%%%OBJECT%%%_merge_action=null ",
      "where branch_id= %%%dst_branch_id%%% ",
        "and branch_%%%OBJECT%%%_action='ADD' ",
        "and (branch_%%%OBJECT%%%_merge_action='DELETE' or branch_%%%OBJECT%%%_merge_action='UPDATE');",

      // Otherwise, use updated merge columns
      "update {schema}.branch_%%%OBJECT%%% set ",
        "%%%OBJECT%%%_id=%%%OBJECT%%%_merge_id, ",
        "branch_%%%OBJECT%%%_action=branch_%%%OBJECT%%%_merge_action, ",
        "%%%OBJECT%%%_merge_id=null, ",
        "branch_%%%OBJECT%%%_merge_action=null ",
      "where branch_id= %%%dst_branch_id%%% ",
        "and (branch_%%%OBJECT%%%_merge_action is not null or %%%OBJECT%%%_merge_id is not null);",

      // exists in src but not dst
      "insert into {schema}.branch_%%%OBJECT%%%( ",
        "branch_id, ",
        "%%%OBJECT%%%_key, ",
        "%%%OBJECT%%%_id, ",
        "%%%OBJECT%%%_orig_id, ",
        "branch_%%%OBJECT%%%_action ",
      ") select ",
        " %%%dst_branch_id%%%, ",
        "%%%OBJECT%%%_key, ",
        "%%%OBJECT%%%_id, ",
        "%%%OBJECT%%%_orig_id, ",
        "branch_%%%OBJECT%%%_action ",
      "from {schema}.branch_%%%OBJECT%%% ",
      "where branch_id= %%%src_branch_id%%% ",
        "and (branch_%%%OBJECT%%%_action='ADD' ",
          "or branch_%%%OBJECT%%%_action='UPDATE' ",
          "or branch_%%%OBJECT%%%_action='DELETE') ",
        "and %%%OBJECT%%%_key not in ",
          "(select %%%OBJECT%%%_key ",
           "from {schema}.branch_%%%OBJECT%%% ",
           "where branch_id= %%%dst_branch_id%%%);"
    ]
  },
  "{schema}.merge_rebase":{
    "params": ["OBJECT", "src_branch_id", "dst_branch_id"],
    "sql": [
      // edit branch is the one being changed, so just copy merge conflict over to edit columns and continue as normal
      "update {schema}.branch_%%%OBJECT%%% ",
      "set ",
        "%%%OBJECT%%%_id=%%%OBJECT%%%_merge_id, ",
        "branch_%%%OBJECT%%%_action=branch_%%%OBJECT%%%_merge_action ",
      "where branch_id= %%%dst_branch_id%%% ",
        "and (%%%OBJECT%%%_merge_id is not null ",
          "or branch_%%%OBJECT%%%_merge_action is not null);",

      // unmodified/deleted items missing (or DELETE) in new base
      "delete from {schema}.branch_%%%OBJECT%%% where branch_id= %%%dst_branch_id%%% and (branch_%%%OBJECT%%%_action is null or branch_%%%OBJECT%%%_action='DELETE') and %%%OBJECT%%%_key not in (select %%%OBJECT%%%_key from {schema}.branch_%%%OBJECT%%% where branch_id= %%%src_branch_id%%% and %%%OBJECT%%%_id is not null);",

      // UPDATE, missing in new base (or DELETE) - turn into ADD
      "update {schema}.branch_%%%OBJECT%%% set %%%OBJECT%%%_orig_id=null, branch_%%%OBJECT%%%_action='ADD' where branch_id= %%%dst_branch_id%%% and branch_%%%OBJECT%%%_action='UPDATE' and  %%%OBJECT%%%_key not in (select %%%OBJECT%%%_key from {schema}.branch_%%%OBJECT%%% where branch_id= %%%src_branch_id%%% and %%%OBJECT%%%_id is not null);",

      // unmodified items from new base
      "update {schema}.branch_%%%OBJECT%%% set %%%OBJECT%%%_id=(select %%%OBJECT%%%_id from (select %%%OBJECT%%%_id,%%%OBJECT%%%_key src_%%%OBJECT%%%_key from {schema}.branch_%%%OBJECT%%% where branch_id= %%%src_branch_id%%%) tbl where src_%%%OBJECT%%%_key=%%%OBJECT%%%_key), %%%OBJECT%%%_orig_id=(select %%%OBJECT%%%_id from (select %%%OBJECT%%%_id,%%%OBJECT%%%_key src_%%%OBJECT%%%_key from {schema}.branch_%%%OBJECT%%% where branch_id= %%%src_branch_id%%%) tbl where src_%%%OBJECT%%%_key=%%%OBJECT%%%_key) where branch_id= %%%dst_branch_id%%% and branch_%%%OBJECT%%%_action is null and %%%OBJECT%%%_key in (select %%%OBJECT%%%_key from {schema}.branch_%%%OBJECT%%% where branch_id= %%%src_branch_id%%%);",

      // ADD, exists on base (and not DELETE) - turn into UPDATE.
      // Orig id will be updated below, but has to exist for db validations
      "update {schema}.branch_%%%OBJECT%%% set %%%OBJECT%%%_orig_id=%%%OBJECT%%%_id, branch_%%%OBJECT%%%_action='UPDATE' where branch_id= %%%dst_branch_id%%% and branch_%%%OBJECT%%%_action='ADD' and %%%OBJECT%%%_key in (select %%%OBJECT%%%_key from {schema}.branch_%%%OBJECT%%% where branch_id= %%%src_branch_id%%% and %%%OBJECT%%%_id is not null);",

      // UPDATE/DELETE: update orig id with current id
      "update {schema}.branch_%%%OBJECT%%% set %%%OBJECT%%%_orig_id=(select %%%OBJECT%%%_id from (select %%%OBJECT%%%_id,%%%OBJECT%%%_key src_%%%OBJECT%%%_key from {schema}.branch_%%%OBJECT%%% where branch_id= %%%src_branch_id%%%) tbl where src_%%%OBJECT%%%_key=%%%OBJECT%%%_key) where branch_id= %%%dst_branch_id%%% and (branch_%%%OBJECT%%%_action='DELETE' or branch_%%%OBJECT%%%_action='UPDATE') and %%%OBJECT%%%_key in (select %%%OBJECT%%%_key from {schema}.branch_%%%OBJECT%%% where branch_id= %%%src_branch_id%%% and %%%OBJECT%%%_id is not null);",

      // new items from base (except DELETE)
      "insert into {schema}.branch_%%%OBJECT%%% (branch_id, %%%OBJECT%%%_key, %%%OBJECT%%%_id, %%%OBJECT%%%_orig_id) select %%%dst_branch_id%%%, %%%OBJECT%%%_key, %%%OBJECT%%%_id, %%%OBJECT%%%_id from {schema}.branch_%%%OBJECT%%% where branch_id= %%%src_branch_id%%% and %%%OBJECT%%%_id is not null and %%%OBJECT%%%_key not in (select %%%OBJECT%%%_key from {schema}.branch_%%%OBJECT%%% where branch_id= %%%dst_branch_id%%%);"
    ]
  }
}