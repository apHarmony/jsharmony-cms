{
  "code_branch_type": {
    "type": "code",
    "caption": "Branch Type",
    "init_data": [
      { "code_val": "USER", "code_txt": "User", "code_seq": 1 },
      { "code_val": "PUBLIC", "code_txt": "Public", "code_seq": 2 }
    ]
  },

  "code_branch_sts": {
    "type": "code",
    "caption": "Branch Status",
    "init_data": [
      { "code_val": "ACTIVE", "code_txt": "Active", "code_seq": 1 },
      { "code_val": "REVIEW", "code_txt": "Review", "code_seq": 2 },
      { "code_val": "ARCHIVE", "code_txt": "Archive", "code_seq": 3 }
    ]
  },

  "code_branch_review_sts": {
    "type": "code",
    "caption": "Branch Review Status",
    "init_data": [
      { "code_val": "APPROVED", "code_txt": "Approved", "code_seq": 1 },
      { "code_val": "PENDING", "code_txt": "Pending", "code_seq": 2 },
      { "code_val": "REJECTED", "code_txt": "Rejected", "code_seq": 3 }
    ]
  },

  "code_branch_item_action": {
    "type": "code",
    "caption": "Branch Item Action",
    "init_data": [
      { "code_val": "ADD", "code_txt": "Add", "code_seq": 1 },
      { "code_val": "DELETE", "code_txt": "Delete", "code_seq": 2 },
      { "code_val": "UPDATE", "code_txt": "Update", "code_seq": 3 }
    ]
  },

  "branch": {
    "type": "table",
    "caption": ["Branch", "Branches"],
    "columns": [
      { "name": "branch_id", "type": "bigint", "key": true, "identity": true, "null": false },
      { "name": "branch_name", "type": "varchar", "length": 256, "null": false },
      { "name": "branch_type", "type": "varchar", "length": 32, "foreignkey": { "code_branch_type": "code_val" }, "null": false },
      { "name": "branch_sts", "type": "varchar", "length": 32, "foreignkey": { "code_branch_sts": "code_val" }, "null": false },
      { "name": "branch_review_sts", "type": "varchar", "length": 32, "foreignkey": { "code_branch_review_sts": "code_val" } },
      { "name": "branch_user_id", "type": "bigint", "foreignkey": { "jsharmony.sys_user": "sys_user_id" } },
      { "name": "branch_parent_id", "type": "bigint", "foreignkey": { "branch": "branch_id" } },

      { "name": "branch_sts_tstmp", "type": "datetime", "length": 7 },
      { "name": "branch_sts_user", "type": "varchar", "length": 20 },
      { "name": "branch_review_sts_tstmp", "type": "datetime", "length": 7 },
      { "name": "branch_review_sts_user", "type": "varchar", "length": 20 },
      { "name": "branch_etstmp", "type": "datetime", "length": 7, "default": { "sql": "%%%%%%jsh.map.timestamp%%%%%%" } },
      { "name": "branch_euser", "type": "varchar", "length": 20, "default": { "sql": "%%%%%%jsh.map.current_user%%%%%%" } },
      { "name": "branch_mtstmp", "type": "datetime", "length": 7 },
      { "name": "branch_muser", "type": "varchar", "length": 20 }
    ],
    "unique": [
      ["branch_name","branch_user_id"]
    ],
    "triggers": [
      { "on": ["validate_update", "validate_insert"], "exec": [
          "errorif(inserted(branch_type)='PUBLIC' and inserted(branch_sts)='REVIEW','Cannot set branch_sts REVIEW on PUBLIC branch');"
        ]
      },
      { "on": ["update", "insert"], "exec": [
          "set(branch_mtstmp,%%%%%%jsh.map.timestamp%%%%%%);",
          "set(branch_muser,%%%%%%jsh.map.current_user%%%%%%);",
          "setif(update(branch_sts),branch_sts_tstmp,%%%%%%jsh.map.timestamp%%%%%%);",
          "setif(update(branch_sts),branch_sts_user,%%%%%%jsh.map.current_user%%%%%%);",
          "setif(update(branch_review_sts),branch_review_sts_tstmp,%%%%%%jsh.map.timestamp%%%%%%);",
          "setif(update(branch_review_sts),branch_review_sts_user,%%%%%%jsh.map.current_user%%%%%%);"
        ]
      }
    ],
    "sample_data": [
      { "branch_name": "master", "branch_type": "PUBLIC", "branch_sts": "ACTIVE" }
    ]
  },
  
  "branch_menu": {
    "type": "table",
    "caption": ["Branch Menu", "Branch Menus"],
    "columns": [
      { "name": "branch_menu_id", "type": "bigint", "key": true, "identity": true, "null": false },
      { "name": "branch_id", "type": "bigint", "foreignkey": { "branch": "branch_id" }, "null": false, "actions": ["prevent_update"] },
      { "name": "menu_key", "type": "bigint", "foreignkey": { "menu": "menu_id" }, "null": false, "actions": ["prevent_update"] },
      { "name": "menu_id", "type": "bigint", "foreignkey": { "menu": "menu_id" } },
      { "name": "branch_menu_action", "type": "varchar", "length": 32, "foreignkey": { "code_branch_item_action": "code_val" } },
      { "name": "menu_orig_id", "type": "bigint", "foreignkey": { "menu": "menu_id" } },
      
      { "name": "branch_menu_etstmp", "type": "datetime", "length": 7, "default": { "sql": "%%%%%%jsh.map.timestamp%%%%%%" } },
      { "name": "branch_menu_euser", "type": "varchar", "length": 20, "default": { "sql": "%%%%%%jsh.map.current_user%%%%%%" } },
      { "name": "branch_menu_mtstmp", "type": "datetime", "length": 7 },
      { "name": "branch_menu_muser", "type": "varchar", "length": 20 }
    ],
    "unique": [
      ["branch_id","menu_key"]
    ],
    "triggers": [
      { "on": ["validate_update", "validate_insert"], "exec": [
          "errorif(inserted(branch_menu_action)='DELETE' and null(inserted(menu_orig_id)),'menu_orig_id is required for DELETE action');",
          "errorif(inserted(branch_menu_action)='UPDATE' and null(inserted(menu_id)),'menu_id is required for UPDATE action');",
          "errorif(inserted(branch_menu_action)='UPDATE' and null(inserted(menu_orig_id)),'menu_orig_id is required for UPDATE action');",
          "errorif(inserted(branch_menu_action)='ADD' and null(inserted(menu_id)),'menu_id is required for ADD action');",
          "errorif(inserted(branch_menu_action)='ADD' and not(null(inserted(menu_orig_id))),'menu_orig_id must be null for ADD action');"
        ]
      },
      { "on": ["update", "insert"], "exec": [
          "set(branch_menu_mtstmp,%%%%%%jsh.map.timestamp%%%%%%);",
          "set(branch_menu_muser,%%%%%%jsh.map.current_user%%%%%%);",
          "setif(branch_menu.branch_menu_action='DELETE',menu_id,null);"
        ]
      }
    ],
    "sample_data": [
      { 
        "branch_id": {"sql":"(select top1(branch_id from {schema}.branch where branch_name='master' and branch_user_id is null))"},
        "menu_key": {"sql":"(select top1(menu_key from {schema}.menu where menu_name='Site Menu'))"},
        "menu_id": {"sql":"(select top1(menu_id from {schema}.menu where menu_name='Site Menu'))"}
      },
      { 
        "branch_id": {"sql":"(select top1(branch_id from {schema}.branch where branch_name='master' and branch_user_id is null))"},
        "menu_key": {"sql":"(select top1(menu_key from {schema}.menu where menu_name='Footer Menu'))"},
        "menu_id": {"sql":"(select top1(menu_id from {schema}.menu where menu_name='Footer Menu'))"}
      }
    ]
  },

  "branch_page": {
    "type": "table",
    "caption": ["Branch Page", "Branch Pages"],
    "columns": [
      { "name": "branch_page_id", "type": "bigint", "key": true, "identity": true, "null": false },
      { "name": "branch_id", "type": "bigint", "foreignkey": { "branch": "branch_id" }, "null": false, "actions": ["prevent_update"] },
      { "name": "page_key", "type": "bigint", "foreignkey": { "page": "page_id" }, "null": false, "actions": ["prevent_update"] },
      { "name": "page_id", "type": "bigint", "foreignkey": { "page": "page_id" } },
      { "name": "branch_page_action", "type": "varchar", "length": 32, "foreignkey": { "code_branch_item_action": "code_val" } },
      { "name": "page_orig_id", "type": "bigint", "foreignkey": { "page": "page_id" } },
      
      { "name": "branch_page_etstmp", "type": "datetime", "length": 7, "default": { "sql": "%%%%%%jsh.map.timestamp%%%%%%" } },
      { "name": "branch_page_euser", "type": "varchar", "length": 20, "default": { "sql": "%%%%%%jsh.map.current_user%%%%%%" } },
      { "name": "branch_page_mtstmp", "type": "datetime", "length": 7 },
      { "name": "branch_page_muser", "type": "varchar", "length": 20 }
    ],
    "unique": [
      ["branch_id","page_key"]
    ],
    "triggers": [
      { "on": ["validate_update", "validate_insert"], "exec": [
          "errorif(inserted(branch_page_action)='DELETE' and null(inserted(page_orig_id)),'page_orig_id is required for DELETE action');",
          "errorif(inserted(branch_page_action)='UPDATE' and null(inserted(page_id)),'page_id is required for UPDATE action');",
          "errorif(inserted(branch_page_action)='UPDATE' and null(inserted(page_orig_id)),'page_orig_id is required for UPDATE action');",
          "errorif(inserted(branch_page_action)='ADD' and null(inserted(page_id)),'page_id is required for ADD action');",
          "errorif(inserted(branch_page_action)='ADD' and not(null(inserted(page_orig_id))),'page_orig_id must be null for ADD action');"
        ]
      },
      { "on": ["update", "insert"], "exec": [
          "set(branch_page_mtstmp,%%%%%%jsh.map.timestamp%%%%%%);",
          "set(branch_page_muser,%%%%%%jsh.map.current_user%%%%%%);",
          "setif(branch_page.branch_page_action='DELETE',page_id,null);"
        ]
      }
    ]
  },

  "branch_media": {
    "type": "table",
    "caption": ["Branch Media", "Branch Media"],
    "columns": [
      { "name": "branch_media_id", "type": "bigint", "key": true, "identity": true, "null": false },
      { "name": "branch_id", "type": "bigint", "foreignkey": { "branch": "branch_id" }, "null": false, "actions": ["prevent_update"] },
      { "name": "media_key", "type": "bigint", "foreignkey": { "media": "media_id" }, "null": false , "actions": ["prevent_update"]},
      { "name": "media_id", "type": "bigint", "foreignkey": { "media": "media_id" } },
      { "name": "branch_media_action", "type": "varchar", "length": 32, "foreignkey": { "code_branch_item_action": "code_val" } },
      { "name": "media_orig_id", "type": "bigint", "foreignkey": { "media": "media_id" } },
      
      { "name": "branch_media_etstmp", "type": "datetime", "length": 7, "default": { "sql": "%%%%%%jsh.map.timestamp%%%%%%" } },
      { "name": "branch_media_euser", "type": "varchar", "length": 20, "default": { "sql": "%%%%%%jsh.map.current_user%%%%%%" } },
      { "name": "branch_media_mtstmp", "type": "datetime", "length": 7 },
      { "name": "branch_media_muser", "type": "varchar", "length": 20 }
    ],
    "unique": [
      ["branch_id","media_key"]
    ],
    "triggers": [
      { "on": ["validate_update", "validate_insert"], "exec": [
          "errorif(inserted(branch_media_action)='DELETE' and null(inserted(media_orig_id)),'media_orig_id is required for DELETE action');",
          "errorif(inserted(branch_media_action)='UPDATE' and null(inserted(media_id)),'media_id is required for UPDATE action');",
          "errorif(inserted(branch_media_action)='UPDATE' and null(inserted(media_orig_id)),'media_orig_id is required for UPDATE action');",
          "errorif(inserted(branch_media_action)='ADD' and null(inserted(media_id)),'media_id is required for ADD action');",
          "errorif(inserted(branch_media_action)='ADD' and not(null(inserted(media_orig_id))),'media_orig_id must be null for ADD action');"
        ]
      },
      { "on": ["update", "insert"], "exec": [
          "set(branch_media_mtstmp,%%%%%%jsh.map.timestamp%%%%%%);",
          "set(branch_media_muser,%%%%%%jsh.map.current_user%%%%%%);",
          "setif(branch_media.branch_media_action='DELETE',media_id,null);"
        ]
      }
    ]
  }
}