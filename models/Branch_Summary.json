{
  "Branch_Summary": {
    "layout":"form",
    "table":"{schema}.branch",
    "onecolumn":true,
    "roles": {"AUTHOR": "B", "VIEWER": "B"},
    "actions":"B",
    "caption":["Branch","Branches"],
    "title":"Branch Summary",
    "onload":"_this.oninit(xmodel);",
    "buttons":[
      { "link":"js:jsh.System.MergeFromBranch(xmodel);","icon":"sidebar","text":"Merge Into Current Branch","class":"Branch_Summary_buttonMerge" },
      { "link":"update:Branch_Clone","icon":"copy","text":"Clone" },
      { "link":"update:Branch_Checkout","icon":"edit","text":"Checkout / Edit Branch","class":"Branch_Summary_buttonCheckout" },
      { "link":"js:jsh.System.PublishBranch(xmodel.get('branch_id', this))","icon":"ok","text":"Publish","class":"Branch_Summary_buttonPublish"}
    ],
    "fields": [
      { "name":"branch_sts","control":"hidden"},
      { "name":"branch_is_checked_out","control":"hidden","sqlselect":"(select branch_is_checked_out from {schema}.v_my_branch_desc where branch_id={schema}.branch.branch_id)"},
      { "name":"src_branch_desc","control":"hidden","sqlselect":"(select branch_desc from {schema}.v_my_branch_desc where branch_id={schema}.branch.branch_id)"},
      { "name":"dst_branch_desc","control":"hidden","sqlselect":"(select branch_desc from {schema}.v_my_branch_desc where branch_is_checked_out == 1)"},
      { "name":"dst_branch_id","control":"hidden","sqlselect":"(select branch_id from {schema}.v_my_branch_desc where branch_is_checked_out == 1)"},
      { "control":"subform","target":"Branch_Diff","actions":"BU","controlparams":{"panelstyle":"border:none;padding:0"}},
    ]
  },
  "Branch_Summary_Merge_CHANGES": {
    "layout": "exec",
    "title": "Merge Branch",
    "actions": "U",
    "roles": {"AUTHOR": "BU", "VIEWER": "BU"},
    "sqlexec": [
      "insert into {schema}.branch_menu(branch_id, menu_key, menu_id, menu_orig_id, branch_menu_action) select @dst_branch_id, menu_key, menu_id, menu_orig_id, branch_menu_action from {schema}.branch_menu where branch_id=@src_branch_id and (branch_menu_action='ADD' or branch_menu_action='UPDATE' or branch_menu_action='DELETE') and menu_key not in (select menu_key from {schema}.branch_menu where branch_id=@dst_branch_id);",
      "insert into {schema}.branch_page(branch_id, page_key, page_id, page_orig_id, branch_page_action) select @dst_branch_id, page_key, page_id, page_orig_id, branch_page_action from {schema}.branch_page where branch_id=@src_branch_id and (branch_page_action='ADD' or branch_page_action='UPDATE' or branch_page_action='DELETE') and page_key not in (select page_key from {schema}.branch_page where branch_id=@dst_branch_id);",
      "insert into {schema}.branch_media(branch_id, media_key, media_id, media_orig_id, branch_media_action) select @dst_branch_id, media_key, media_id, media_orig_id, branch_media_action from {schema}.branch_media where branch_id=@src_branch_id and (branch_media_action='ADD' or branch_media_action='UPDATE' or branch_media_action='DELETE') and media_key not in (select media_key from {schema}.branch_media where branch_id=@dst_branch_id);",
      "insert into {schema}.branch_redirect(branch_id, redirect_key, redirect_id, redirect_orig_id, branch_redirect_action) select @dst_branch_id, redirect_key, redirect_id, redirect_orig_id, branch_redirect_action from {schema}.branch_redirect where branch_id=@src_branch_id and (branch_redirect_action='ADD' or branch_redirect_action='UPDATE' or branch_redirect_action='DELETE') and redirect_key not in (select redirect_key from {schema}.branch_redirect where branch_id=@dst_branch_id);",

      // UPDATE/DELETE: use src branch
      "update {schema}.branch_menu set menu_id=(select menu_id from (select menu_id,menu_key src_menu_key from {schema}.branch_menu where branch_id=@src_branch_id) tbl where src_menu_key=menu_key), branch_menu_action=(select branch_menu_action from (select branch_menu_action,menu_key src_menu_key from {schema}.branch_menu where branch_id=@src_branch_id) tbl where src_menu_key=menu_key), menu_orig_id=(select menu_orig_id from (select menu_orig_id,menu_key src_menu_key from {schema}.branch_menu where branch_id=@src_branch_id) tbl where src_menu_key=menu_key) where branch_id=@dst_branch_id and menu_key in (select menu_key from {schema}.branch_menu where branch_id=@src_branch_id and (branch_menu_action='DELETE' or branch_menu_action='UPDATE'));",
      "update {schema}.branch_page set page_id=(select page_id from (select page_id,page_key src_page_key from {schema}.branch_page where branch_id=@src_branch_id) tbl where src_page_key=page_key), branch_page_action=(select branch_page_action from (select branch_page_action,page_key src_page_key from {schema}.branch_page where branch_id=@src_branch_id) tbl where src_page_key=page_key), page_orig_id=(select page_orig_id from (select page_orig_id,page_key src_page_key from {schema}.branch_page where branch_id=@src_branch_id) tbl where src_page_key=page_key) where branch_id=@dst_branch_id and page_key in (select page_key from {schema}.branch_page where branch_id=@src_branch_id and (branch_page_action='DELETE' or branch_page_action='UPDATE'));",
      "update {schema}.branch_media set media_id=(select media_id from (select media_id,media_key src_media_key from {schema}.branch_media where branch_id=@src_branch_id) tbl where src_media_key=media_key), branch_media_action=(select branch_media_action from (select branch_media_action,media_key src_media_key from {schema}.branch_media where branch_id=@src_branch_id) tbl where src_media_key=media_key), media_orig_id=(select media_orig_id from (select media_orig_id,media_key src_media_key from {schema}.branch_media where branch_id=@src_branch_id) tbl where src_media_key=media_key) where branch_id=@dst_branch_id and media_key in (select media_key from {schema}.branch_media where branch_id=@src_branch_id and (branch_media_action='DELETE' or branch_media_action='UPDATE'));",
      "update {schema}.branch_redirect set redirect_id=(select redirect_id from (select redirect_id,redirect_key src_redirect_key from {schema}.branch_redirect where branch_id=@src_branch_id) tbl where src_redirect_key=redirect_key), branch_redirect_action=(select branch_redirect_action from (select branch_redirect_action,redirect_key src_redirect_key from {schema}.branch_redirect where branch_id=@src_branch_id) tbl where src_redirect_key=redirect_key), redirect_orig_id=(select redirect_orig_id from (select redirect_orig_id,redirect_key src_redirect_key from {schema}.branch_redirect where branch_id=@src_branch_id) tbl where src_redirect_key=redirect_key) where branch_id=@dst_branch_id and redirect_key in (select redirect_key from {schema}.branch_redirect where branch_id=@src_branch_id and (branch_redirect_action='DELETE' or branch_redirect_action='UPDATE'));",

      // ADD on UPDATE/DELETE: UPDATE with dst orig
      "update {schema}.branch_menu set menu_id=(select menu_id from (select menu_id,menu_key src_menu_key from {schema}.branch_menu where branch_id=@src_branch_id) tbl where src_menu_key=menu_key), branch_menu_action='UPDATE' where branch_id=@dst_branch_id and (branch_menu_action='DELETE' or branch_menu_action='UPDATE') and menu_key in (select menu_key from {schema}.branch_menu where branch_id=@src_branch_id and (branch_menu_action='ADD'));",
      "update {schema}.branch_page set page_id=(select page_id from (select page_id,page_key src_page_key from {schema}.branch_page where branch_id=@src_branch_id) tbl where src_page_key=page_key), branch_page_action='UPDATE' where branch_id=@dst_branch_id and (branch_page_action='DELETE' or branch_page_action='UPDATE') and page_key in (select page_key from {schema}.branch_page where branch_id=@src_branch_id and (branch_page_action='ADD'));",
      "update {schema}.branch_media set media_id=(select media_id from (select media_id,media_key src_media_key from {schema}.branch_media where branch_id=@src_branch_id) tbl where src_media_key=media_key), branch_media_action='UPDATE' where branch_id=@dst_branch_id and (branch_media_action='DELETE' or branch_media_action='UPDATE') and media_key in (select media_key from {schema}.branch_media where branch_id=@src_branch_id and (branch_media_action='ADD'));",
      "update {schema}.branch_redirect set redirect_id=(select redirect_id from (select redirect_id,redirect_key src_redirect_key from {schema}.branch_redirect where branch_id=@src_branch_id) tbl where src_redirect_key=redirect_key), branch_redirect_action='UPDATE' where branch_id=@dst_branch_id and (branch_redirect_action='DELETE' or branch_redirect_action='UPDATE') and redirect_key in (select redirect_key from {schema}.branch_redirect where branch_id=@src_branch_id and (branch_redirect_action='ADD'));",

      // ADD on noop/ADD: ADD src
      "update {schema}.branch_menu set menu_id=(select menu_id from (select menu_id,menu_key src_menu_key from {schema}.branch_menu where branch_id=@src_branch_id) tbl where src_menu_key=menu_key), branch_menu_action='ADD' where branch_id=@dst_branch_id and (branch_menu_action='ADD' or branch_menu_action is null) and menu_key in (select menu_key from {schema}.branch_menu where branch_id=@src_branch_id and (branch_menu_action='ADD'));",
      "update {schema}.branch_page set page_id=(select page_id from (select page_id,page_key src_page_key from {schema}.branch_page where branch_id=@src_branch_id) tbl where src_page_key=page_key), branch_page_action='ADD' where branch_id=@dst_branch_id and (branch_page_action='ADD' or branch_page_action is null) and page_key in (select page_key from {schema}.branch_page where branch_id=@src_branch_id and (branch_page_action='ADD'));",
      "update {schema}.branch_media set media_id=(select media_id from (select media_id,media_key src_media_key from {schema}.branch_media where branch_id=@src_branch_id) tbl where src_media_key=media_key), branch_media_action='ADD' where branch_id=@dst_branch_id and (branch_media_action='ADD' or branch_media_action is null) and media_key in (select media_key from {schema}.branch_media where branch_id=@src_branch_id and (branch_media_action='ADD'));",
      "update {schema}.branch_redirect set redirect_id=(select redirect_id from (select redirect_id,redirect_key src_redirect_key from {schema}.branch_redirect where branch_id=@src_branch_id) tbl where src_redirect_key=redirect_key), branch_redirect_action='ADD' where branch_id=@dst_branch_id and (branch_redirect_action='ADD' or branch_redirect_action is null) and redirect_key in (select redirect_key from {schema}.branch_redirect where branch_id=@src_branch_id and (branch_redirect_action='ADD'));"
    ],
    "fields": [
      {"name":"src_branch_id", "actions":"BU", "type":"bigint", "key": 1, "caption":"Source Branch ID"},
      {"name":"dst_branch_id", "actions":"BU", "type":"bigint", "key": 1, "caption":"Destination Branch ID"}
    ]
  },
  "Branch_Summary_Merge_REBASE": {
    "layout": "exec",
    "title": "Merge Branch",
    "actions": "U",
    "roles": {"AUTHOR": "BU", "VIEWER": "BU"},
    "sqlexec": [
      // unmodified/deleted items missing new new base
      "delete from {schema}.branch_menu where branch_id=@dst_branch_id and (branch_menu_action is null or branch_menu_action='DELETE') and menu_key not in (select menu_key from {schema}.branch_menu where branch_id=@src_branch_id);",
      "delete from {schema}.branch_page where branch_id=@dst_branch_id and (branch_page_action is null or branch_page_action='DELETE') and page_key not in (select page_key from {schema}.branch_page where branch_id=@src_branch_id);",
      "delete from {schema}.branch_media where branch_id=@dst_branch_id and (branch_media_action is null or branch_media_action='DELETE') and media_key not in (select media_key from {schema}.branch_media where branch_id=@src_branch_id);",
      "delete from {schema}.branch_redirect where branch_id=@dst_branch_id and (branch_redirect_action is null or branch_redirect_action='DELETE') and redirect_key not in (select redirect_key from {schema}.branch_redirect where branch_id=@src_branch_id);",

      // UPDATE, missing in new base - turn into ADD
      "update {schema}.branch_menu set menu_orig_id=null, branch_menu_action='ADD' where branch_id=@dst_branch_id and branch_menu_action='UPDATE' and  menu_key not in (select menu_key from {schema}.branch_menu where branch_id=@src_branch_id);",
      "update {schema}.branch_page set page_orig_id=null, branch_page_action='ADD' where branch_id=@dst_branch_id and branch_page_action='UPDATE' and  page_key not in (select page_key from {schema}.branch_page where branch_id=@src_branch_id);",
      "update {schema}.branch_media set media_orig_id=null, branch_media_action='ADD' where branch_id=@dst_branch_id and branch_media_action='UPDATE' and  media_key not in (select media_key from {schema}.branch_media where branch_id=@src_branch_id);",
      "update {schema}.branch_redirect set redirect_orig_id=null, branch_redirect_action='ADD' where branch_id=@dst_branch_id and branch_redirect_action='UPDATE' and  redirect_key not in (select redirect_key from {schema}.branch_redirect where branch_id=@src_branch_id);",

      // unmodified items from new base
      "update {schema}.branch_menu set menu_id=(select menu_id from (select menu_id,menu_key src_menu_key from {schema}.branch_menu where branch_id=@src_branch_id) tbl where src_menu_key=menu_key) where branch_id=@dst_branch_id and branch_menu_action is null and menu_key in (select menu_key from {schema}.branch_menu where branch_id=@src_branch_id);",
      "update {schema}.branch_page set page_id=(select page_id from (select page_id,page_key src_page_key from {schema}.branch_page where branch_id=@src_branch_id) tbl where src_page_key=page_key) where branch_id=@dst_branch_id and branch_page_action is null and page_key in (select page_key from {schema}.branch_page where branch_id=@src_branch_id);",
      "update {schema}.branch_media set media_id=(select media_id from (select media_id,media_key src_media_key from {schema}.branch_media where branch_id=@src_branch_id) tbl where src_media_key=media_key) where branch_id=@dst_branch_id and branch_media_action is null and media_key in (select media_key from {schema}.branch_media where branch_id=@src_branch_id);",
      "update {schema}.branch_redirect set redirect_id=(select redirect_id from (select redirect_id,redirect_key src_redirect_key from {schema}.branch_redirect where branch_id=@src_branch_id) tbl where src_redirect_key=redirect_key) where branch_id=@dst_branch_id and branch_redirect_action is null and redirect_key in (select redirect_key from {schema}.branch_redirect where branch_id=@src_branch_id);",

      // ADD, exists on base - turn into UPDATE
      "update {schema}.branch_menu set menu_orig_id=(select menu_id from (select menu_id,menu_key src_menu_key from {schema}.branch_menu where branch_id=@src_branch_id) tbl where src_menu_key=menu_key), branch_menu_action='UPDATE' where branch_id=@dst_branch_id and branch_menu_action='ADD' and menu_key in (select menu_key from {schema}.branch_menu where branch_id=@src_branch_id);",
      "update {schema}.branch_page set page_orig_id=(select page_id from (select page_id,page_key src_page_key from {schema}.branch_page where branch_id=@src_branch_id) tbl where src_page_key=page_key), branch_page_action='UPDATE' where branch_id=@dst_branch_id and branch_page_action='ADD' and page_key in (select page_key from {schema}.branch_page where branch_id=@src_branch_id);",
      "update {schema}.branch_media set media_orig_id=(select media_id from (select media_id,media_key src_media_key from {schema}.branch_media where branch_id=@src_branch_id) tbl where src_media_key=media_key), branch_media_action='UPDATE' where branch_id=@dst_branch_id and branch_media_action='ADD' and media_key in (select media_key from {schema}.branch_media where branch_id=@src_branch_id);",
      "update {schema}.branch_redirect set redirect_orig_id=(select redirect_id from (select redirect_id,redirect_key src_redirect_key from {schema}.branch_redirect where branch_id=@src_branch_id) tbl where src_redirect_key=redirect_key), branch_redirect_action='UPDATE' where branch_id=@dst_branch_id and branch_redirect_action='ADD' and redirect_key in (select redirect_key from {schema}.branch_redirect where branch_id=@src_branch_id);",

      // UPDATE/DELETE: update orig id
      "update {schema}.branch_menu set menu_orig_id=(select menu_id from (select menu_id,menu_key src_menu_key from {schema}.branch_menu where branch_id=@src_branch_id) tbl where src_menu_key=menu_key) where branch_id=@dst_branch_id and (branch_menu_action='DELETE' or branch_menu_action='UPDATE') and menu_key in (select menu_key from {schema}.branch_menu where branch_id=@src_branch_id);",
      "update {schema}.branch_page set page_orig_id=(select page_id from (select page_id,page_key src_page_key from {schema}.branch_page where branch_id=@src_branch_id) tbl where src_page_key=page_key) where branch_id=@dst_branch_id and (branch_page_action='DELETE' or branch_page_action='UPDATE') and page_key in (select page_key from {schema}.branch_page where branch_id=@src_branch_id);",
      "update {schema}.branch_media set media_orig_id=(select media_id from (select media_id,media_key src_media_key from {schema}.branch_media where branch_id=@src_branch_id) tbl where src_media_key=media_key) where branch_id=@dst_branch_id and (branch_media_action='DELETE' or branch_media_action='UPDATE') and media_key in (select media_key from {schema}.branch_media where branch_id=@src_branch_id);",
      "update {schema}.branch_redirect set redirect_orig_id=(select redirect_id from (select redirect_id,redirect_key src_redirect_key from {schema}.branch_redirect where branch_id=@src_branch_id) tbl where src_redirect_key=redirect_key) where branch_id=@dst_branch_id and (branch_redirect_action='DELETE' or branch_redirect_action='UPDATE') and redirect_key in (select redirect_key from {schema}.branch_redirect where branch_id=@src_branch_id);",

      // new items from base
      "insert into {schema}.branch_menu(branch_id, menu_key, menu_id, menu_orig_id) select @dst_branch_id, menu_key, menu_id, menu_id from {schema}.branch_menu where branch_id=@src_branch_id and menu_key not in (select menu_key from {schema}.branch_menu where branch_id=@dst_branch_id);",
      "insert into {schema}.branch_page(branch_id, page_key, page_id, page_orig_id) select @dst_branch_id, page_key, page_id, page_id from {schema}.branch_page where branch_id=@src_branch_id and page_key not in (select page_key from {schema}.branch_page where branch_id=@dst_branch_id);",
      "insert into {schema}.branch_media(branch_id, media_key, media_id, media_orig_id) select @dst_branch_id, media_key, media_id, media_id from {schema}.branch_media where branch_id=@src_branch_id and media_key not in (select media_key from {schema}.branch_media where branch_id=@dst_branch_id);",
      "insert into {schema}.branch_redirect(branch_id, redirect_key, redirect_id, redirect_orig_id) select @dst_branch_id, redirect_key, redirect_id, redirect_id from {schema}.branch_redirect where branch_id=@src_branch_id and redirect_key not in (select redirect_key from {schema}.branch_redirect where branch_id=@dst_branch_id);"
    ],
    "fields": [
      {"name":"src_branch_id", "actions":"BU", "type":"bigint", "key": 1, "caption":"Source Branch ID"},
      {"name":"dst_branch_id", "actions":"BU", "type":"bigint", "key": 1, "caption":"Destination Branch ID"}
    ]
  }
}